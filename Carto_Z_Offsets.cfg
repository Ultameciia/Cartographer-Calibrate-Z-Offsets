[gcode_macro CARTO_OFFSET_PROBE]
description: Probes the specified tool (T0, T1, etc.) and saves the raw Z height.
gcode:
    {% set TOOL_NUM = params.T|int %}
    {% set HEATER_NAME = "" %}
    {% set TOOL_KEY = 't' ~ TOOL_NUM|string %}

    {% if TOOL_NUM == 0 %}
        {% set HEATER_NAME = "extruder" %}
    {% elif TOOL_NUM == 1 %}
        {% set HEATER_NAME = "extruder1" %}
    {% elif TOOL_NUM == 2 %}
        {% set HEATER_NAME = "extruder2" %}
    {% elif TOOL_NUM == 3 %}
        {% set HEATER_NAME = "extruder3" %}    
    {% else %}
        RESPOND TYPE=error MSG="Tool T{TOOL_NUM} is not handled in this macro."
    {% endif %}
    
    RESPOND TYPE=command MSG="--- Starting probe for Tool T{TOOL_NUM} ---"

    # 1. Probing Sequence
    SELECT_TOOL T={TOOL_NUM}
    G90
    G0 Z10 F600
    
    # Use blocking M109
    M109 S140
    
    G0 X175 Y175 F6000
    CARTOGRAPHER_TOUCH_PROBE

    M104 S0
    DETACH
    
[gcode_macro CARTO_SAVE_RAW]
gcode:
    {% set TOOL_NUM = params.T|int %}
    {% set HEATER_NAME = "" %}
    {% set TOOL_KEY = 't' ~ TOOL_NUM|string %}

    {% if TOOL_NUM == 0 %}
        {% set HEATER_NAME = "extruder" %}
    {% elif TOOL_NUM == 1 %}
        {% set HEATER_NAME = "extruder1" %}
    {% elif TOOL_NUM == 2 %}
        {% set HEATER_NAME = "extruder2" %}
    {% elif TOOL_NUM == 3 %}
        {% set HEATER_NAME = "extruder3" %}
    {% else %}
        RESPOND TYPE=error MSG="Tool T{TOOL_NUM} is not handled in this macro."
    {% endif %}
    
 {% set z_result = printer.cartographer.touch.last_z_result %}
    
    # 3. Cleanup and Reporting
    M104 S0 ; Turn off heater
    
    {% if z_result is not none and z_result != 0.0 %}
        # Save the RAW Z result for later calculation
        SAVE_VARIABLE VARIABLE={TOOL_KEY + '_raw_z'} VALUE={z_result}
        RESPOND TYPE=command MSG="T{TOOL_NUM} RAW Z height saved: {z_result|round(4)}."
    {% else %}
        # Save a fail-safe value
        SAVE_VARIABLE VARIABLE={TOOL_KEY + '_raw_z'} VALUE=9999.0 
        RESPOND TYPE=error MSG="Touch failed for tool T{TOOL_NUM} or returned 0.0. Raw Z height was not saved."
  {% endif %}

[gcode_macro CARTO_CALCULATE_OFFSETS]
description: Calculates the final Z-offsets based on the raw probe data saved in the config.
gcode:
    {% set tools = printer.toolchanger.tool_numbers %}
    {% set t0_raw_z = printer.save_variables.variables['t0_raw_z']|default(0.0)|float %}
    
    {% if t0_raw_z == 0.0 or t0_raw_z == 9999.0 %}
        RESPOND TYPE=error MSG="T0 raw Z reference is invalid or missing. Cannot calculate offsets."
    {% else %}
        
        SAVE_VARIABLE VARIABLE='t0_offset_z' VALUE=0.0
        RESPOND TYPE=command MSG="T0 offset saved as 0.0 (Reference: {t0_raw_z|round(4)})"

        {% for tool_num in tools %}
            {% if tool_num != 0 %}
                {% set raw_z_var = 't' + tool_num|string + '_raw_z' %}
                {% set current_raw_z = printer.save_variables.variables[raw_z_var]|default(0.0)|float %}

                {% if current_raw_z != 0.0 and current_raw_z != 9999.0 %}
                    {% set z_offset = current_raw_z - t0_raw_z %}
                    
                    SAVE_VARIABLE VARIABLE={'t' + tool_num|string + '_offset_z'} VALUE={z_offset}
                    RESPOND TYPE=command MSG="T{tool_num} raw Z: {current_raw_z|round(4)}. Calculated final offset: {z_offset|round(4)}"
                {% else %}
                    RESPOND TYPE=error MSG="T{tool_num} raw Z data missing or invalid. Offset calculation skipped."
                {% endif %}
            {% endif %}
        {% endfor %}
        
        RESPOND TYPE=command MSG="Calculation complete."
    {% endif %}

[gcode_macro CARTO_CALIBRATE_Z_OFFSETS]
gcode:
     CARTO_OFFSET_PROBE T=0
     CARTO_SAVE_RAW T=0
     CARTO_OFFSET_PROBE T=1
     CARTO_SAVE_RAW T=1
     CARTO_OFFSET_PROBE T=2
     CARTO_SAVE_RAW T=2
     CARTO_OFFSET_PROBE T=3
     CARTO_SAVE_RAW T=3     
     CARTO_CALCULATE_OFFSETS
     _MOVE_TO_CENTER

[gcode_macro _MOVE_TO_CENTER]
description: Moves the toolhead to the center of the bed at a safe Z height.
gcode:
    G90                     ; Absolute positioning
    G0 Z10 F600             ; Move to safe Z height
    G0 X175 Y175 F6000      ; Move to bed center
    G0 Z10 F600             ; Move back to a safe height (for safety)

[gcode_macro Detach]
gcode:
      UNSELECT_TOOL
